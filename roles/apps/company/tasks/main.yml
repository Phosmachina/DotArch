---
# Company compliance role - Microsoft Intune
# This role manages company compliance requirements

- name: Install Intune prerequisites (Ubuntu)
  become: true
  ansible.builtin.apt:
    name:
      - curl
      - gpg
    state: present
  when: ansible_facts.distribution == 'Ubuntu'
  tags: [ apps, company ]

- name: Add Microsoft package signing key (Ubuntu)
  become: true
  ansible.builtin.shell: |
    curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /usr/share/keyrings/microsoft-archive-keyring.gpg
  args:
    creates: /usr/share/keyrings/microsoft-archive-keyring.gpg
  when: ansible_facts.distribution == 'Ubuntu'
  tags: [ apps, company ]

- name: Add Microsoft Intune repository (Ubuntu)
  become: true
  ansible.builtin.shell: |
    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-archive-keyring.gpg] https://packages.microsoft.com/ubuntu/{{ ansible_distribution_version }}/prod {{ ansible_distribution_release }} main" > /etc/apt/sources.list.d/microsoft-ubuntu-prod.list
  args:
    creates: /etc/apt/sources.list.d/microsoft-ubuntu-prod.list
  when: ansible_facts.distribution == 'Ubuntu'
  tags: [ apps, company ]

- name: Update apt cache (Ubuntu)
  become: true
  ansible.builtin.apt:
    update_cache: true
  when: ansible_facts.distribution == 'Ubuntu'
  tags: [ apps, company ]

- name: Install Microsoft Intune Portal (Ubuntu)
  become: true
  ansible.builtin.apt:
    name: intune-portal
    state: present
  when: ansible_facts.distribution == 'Ubuntu'
  tags: [ apps, company ]
